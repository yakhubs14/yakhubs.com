<!DOCTYPE html>
<html lang="en">
<head>
  <title>MPM-RAIV // MASTER COMMAND</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- LIBRARIES -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    /* --- CORE THEME --- */
    :root {
      --cyber-blue: #00f0ff;
      --cyber-red: #ff003c;
      --cyber-green: #05ffa1;
      --cyber-yellow: #fcee0a;
      --bg-dark: #020204;
      --panel-bg: rgba(8, 12, 16, 0.95);
      --glass-border: 1px solid rgba(0, 240, 255, 0.3);
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { width: 6px; } 
    ::-webkit-scrollbar-track { background: #000; } 
    ::-webkit-scrollbar-thumb { background: var(--cyber-blue); border-radius: 3px; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 50% 50%, #111 0%, #000 85%),
        linear-gradient(rgba(0, 240, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.02) 1px, transparent 1px);
      background-size: 100% 100%, 50px 50px, 50px 50px;
      font-family: 'Oxanium', cursive; color: white;
      min-height: 100vh; display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden;
    }

    /* --- HEADER --- */
    header {
      height: auto; min-height: 65px; background: #0a0f14; border-bottom: 2px solid var(--cyber-blue);
      display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); z-index: 100; flex-shrink: 0; flex-wrap: wrap; gap: 15px;
    }
    .brand { font-size: 22px; font-weight: 800; color: var(--cyber-blue); text-shadow: 0 0 10px var(--cyber-blue); letter-spacing: 2px; white-space: nowrap; }
    
    .header-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; flex: 1; }
    
    .time-box { 
        background: rgba(0,0,0,0.5); border: 1px solid var(--cyber-blue); 
        color: var(--cyber-blue); padding: 5px 10px; font-family: 'Share Tech Mono'; 
        font-weight: bold; min-width: 110px; text-align: center; font-size: 12px;
    }

    .led-panel { display: flex; gap: 12px; align-items: center; background: #000; padding: 6px 15px; border: 1px solid #333; border-radius: 20px; }
    .led { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #555; transition: 0.2s; }
    .led-label { font-size: 10px; color: #888; margin-left: 5px; font-weight: bold; display: inline-block; }
    .led-red.active { background: var(--cyber-red); box-shadow: 0 0 10px var(--cyber-red); border-color: white; }
    .led-orange.active { background: #ffa500; box-shadow: 0 0 10px #ffa500; border-color: white; animation: blinkFast 0.2s infinite alternate; }
    
    .maint-btn { 
        background: rgba(252, 238, 10, 0.1); border: 1px solid var(--cyber-yellow); color: var(--cyber-yellow);
        font-size: 12px; padding: 6px 12px; cursor: pointer; font-weight: bold;
        transition: 0.3s; white-space: nowrap;
    }
    .maint-btn:hover { background: var(--cyber-yellow); color: black; box-shadow: 0 0 10px var(--cyber-yellow); }

    /* --- LAYOUT GRID --- */
    .cockpit {
      flex: 1; display: grid;
      grid-template-rows: minmax(400px, auto) minmax(350px, auto) auto 250px; 
      grid-template-columns: 350px 1fr 350px;
      gap: 15px; padding: 15px; width: 100%; max-width: 1800px; margin: 0 auto;
    }

    /* --- PANELS --- */
    .panel {
      background: var(--panel-bg); border: var(--glass-border); position: relative;
      clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.9); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; transition: box-shadow 0.3s;
    }
    .panel:hover { box-shadow: inset 0 0 20px rgba(0, 240, 255, 0.1); border-color: rgba(0, 240, 255, 0.6); }
    .panel-header {
      background: linear-gradient(90deg, rgba(0,240,255,0.15), transparent);
      padding: 10px 15px; font-size: 12px; letter-spacing: 2px; color: var(--cyber-blue);
      border-bottom: 1px solid rgba(0,240,255,0.2); display: flex; justify-content: space-between;
      text-transform: uppercase; font-weight: 800; flex-shrink: 0;
    }

    /* --- VIDEO --- */
    .video-section { grid-column: 1 / -1; grid-row: 1 / 2; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; min-height: 400px; }
    .cam-box { background: #000; position: relative; display: flex; justify-content: center; align-items: center; border: 1px solid #333; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.8); transform: translateZ(0); }
    .stream-img { width: 100%; height: 100%; object-fit: contain; display: none; will-change: transform; }
    .cam-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: var(--cyber-red); padding: 3px 8px; font-weight: bold; border: 1px solid var(--cyber-red); font-size: 10px; z-index: 10; }
    .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(0, 240, 255, 0.8); box-shadow: 0 0 15px var(--cyber-blue); animation: scan 4s linear infinite; z-index: 5; }
    .no-sig { color: #444; font-size: 14px; letter-spacing: 3px; animation: flicker 3s infinite; }

    /* --- MAP --- */
    .map-panel { grid-column: 1 / 2; grid-row: 2 / 3; border: 1px solid var(--cyber-green); }
    .map-container { flex: 1; margin: 10px; border: 1px solid #333; position: relative; }
    #map { width: 100%; height: 100%; background: #fff; } 
    .map-overlay { position: absolute; bottom: 10px; right: 10px; z-index: 999; }
    .btn-dir {
      background: var(--cyber-green); color: black; border: none;
      padding: 8px 12px; font-weight: bold; font-family: 'Oxanium';
      cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
      box-shadow: 0 0 10px var(--cyber-green); transition: 0.2s;
    }

    /* --- SPEEDOMETER --- */
    /* DIGITAL DISPLAY */
    .speed-panel { grid-column: 2 / 3; grid-row: 2 / 3; align-items: center; justify-content: center; border-top: 4px solid var(--cyber-blue); padding-bottom: 20px; display: flex; flex-direction: column; }
    
    .digital-speed-container {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%; height: 180px; 
        margin-top: 10px;
    }
    
    .speed-label-top {
        background: rgba(0, 240, 255, 0.1); color: var(--cyber-blue);
        padding: 5px 15px; font-size: 12px; letter-spacing: 2px; font-weight: bold;
        margin-bottom: 10px; border: 1px solid rgba(0, 240, 255, 0.3); text-transform: uppercase;
    }
    
    .digital-speed-val {
        font-family: 'Share Tech Mono', monospace;
        font-size: 100px; font-weight: 800; color: white;
        text-shadow: 0 0 20px rgba(0,240,255,0.8), 0 0 40px rgba(0,240,255,0.4);
        line-height: 1; margin-bottom: 0px;
    }
    
    .digital-unit {
        font-size: 20px; color: var(--cyber-blue); letter-spacing: 4px; font-weight: bold; text-transform: uppercase;
        margin-top: 5px;
    }

    /* SPEED SELECTOR */
    #speed-select-box { display: none; width: 85%; margin-top: 20px; animation: slideDown 0.5s ease-out; }
    .spd-dropdown { width: 100%; background: #050505; color: var(--cyber-yellow); border: 1px solid var(--cyber-yellow); padding: 10px; font-family: 'Oxanium'; font-size: 16px; outline: none; text-align: center; appearance: none; cursor: pointer; box-shadow: 0 0 10px rgba(252, 238, 10, 0.2); }
    .spd-dropdown:hover { background: #111; }
    .spd-title { text-align:center; color: #666; font-size: 10px; letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase; }

    /* --- TELEMETRY --- */
    .data-panel { grid-column: 3 / 4; grid-row: 2 / 3; display: flex; flex-direction: column; gap: 5px; font-size: 13px; overflow: hidden; position: relative; }
    .data-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 5px; transition: opacity 0.3s; }
    .data-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); padding: 10px 15px; border-left: 3px solid #444; flex-shrink: 0; }
    .data-row span:last-child { font-weight: bold; font-size: 15px; font-family: 'Share Tech Mono'; }
    .val-vib { color: var(--cyber-yellow); border-left-color: var(--cyber-yellow); }
    .val-dist { color: var(--cyber-green); border-left-color: var(--cyber-green); }
    .info-btn { background: none; border: 1px solid #666; color: #aaa; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; cursor: pointer; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center; }
    
    /* OFFLINE OVERLAY FOR TELEMETRY */
    .offline-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none; /* Toggled via JS */
        flex-direction: column; justify-content: center; align-items: center;
        z-index: 50; backdrop-filter: blur(5px);
        animation: fadeIn 0.5s;
    }
    .offline-text {
        color: var(--cyber-red); font-weight: 800; font-size: 18px; 
        text-shadow: 0 0 10px var(--cyber-red); letter-spacing: 2px;
        text-align: center; margin-bottom: 10px;
    }
    .offline-sub { font-size: 10px; color: #aaa; letter-spacing: 1px; }
    
    /* TERMINAL */
    .terminal-panel { grid-column: 1 / -1; grid-row: 4 / 5; background: #000; border: 1px solid var(--cyber-green); padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--cyber-green); overflow-y: auto; box-shadow: inset 0 0 20px rgba(5, 255, 161, 0.1); min-height: 120px; }

    /* --- CONTROLS --- */
    .control-container { grid-column: 1 / -1; grid-row: 3 / 4; display: flex; gap: 15px; padding-bottom: 20px; }
    
    #locked-panel {
        grid-column: 1 / -1; grid-row: 3 / 4;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        background: repeating-linear-gradient(45deg, rgba(255,0,60,0.05), rgba(255,0,60,0.05) 10px, rgba(255,0,60,0.1) 10px, rgba(255,0,60,0.1) 20px);
        border: 2px dashed var(--cyber-red); padding: 40px; cursor: pointer; text-align: center;
        transition: 0.3s; animation: pulseRed 3s infinite; min-height: 150px;
    }
    .lock-text { font-size: 20px; font-weight: 800; color: var(--cyber-red); text-shadow: 0 0 10px var(--cyber-red); margin-top: 10px; }
    #control-container { display: none; } 

    .nav-panel { flex: 1.2; background: rgba(0,0,0,0.8); border: 1px solid var(--cyber-blue); padding: 15px; display: flex; flex-direction: column; justify-content: center; clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px); transition: 0.3s; }
    .nav-row { display: flex; align-items: center; gap: 10px; color: var(--cyber-blue); font-weight: bold; font-size: 12px; }
    select { background: #050505; color: white; border: 1px solid var(--cyber-blue); padding: 8px; font-family: 'Oxanium'; font-size: 14px; flex: 1; outline: none; text-transform: uppercase; }
    
    /* Removed cam-config-area as requested */
    
    /* SLIDER */
    .slider-container { width: 100%; display: flex; align-items: center; gap: 10px; margin-top: 10px; transition: opacity 0.3s; }
    input[type=range] { flex: 1; -webkit-appearance: none; height: 10px; background: #222; border-radius: 5px; outline: none; border: 1px solid #444; }
    input[type=range]::-webkit-slider-thumb { 
      -webkit-appearance: none; width: 24px; height: 24px; background: var(--cyber-blue); cursor: pointer; border-radius: 50%; 
      box-shadow: 0 0 15px var(--cyber-blue); border: 2px solid white;
    }
    .slider-val { width: 80px; text-align: right; color: var(--cyber-blue); font-weight: bold; font-size: 18px; }

    /* BUTTONS */
    .control-bar { flex: 2; display: flex; gap: 10px; }
    .btn {
      flex: 1; border: none; font-family: 'Oxanium'; font-weight: 800; letter-spacing: 1px; cursor: pointer; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); font-size: 20px; transition: 0.1s; display: flex; align-items: center; justify-content: center;
    }
    .btn-fwd { background: rgba(5,255,161,0.15); color: var(--cyber-green); border: 2px solid var(--cyber-green); }
    .btn-fwd:active { background: white; color: black; box-shadow: 0 0 40px var(--cyber-green); }
    .btn-stop { flex: 0.6; background: rgba(255,0,60,0.15); color: var(--cyber-red); border: 2px solid var(--cyber-red); }
    .btn-stop:active { background: white; color: black; box-shadow: 0 0 40px var(--cyber-red); }
    .btn-bwd { background: rgba(252,238,10,0.15); color: var(--cyber-yellow); border: 2px solid var(--cyber-yellow); }
    .btn-bwd:active { background: white; color: black; box-shadow: 0 0 40px var(--cyber-yellow); }
    
    .btn-data { flex: 0.4; background: rgba(0,240,255,0.1); color: var(--cyber-blue); border: 1px solid var(--cyber-blue); font-size: 14px; }

    /* --- BOTTOM SECTION (SPLIT TERMINAL & MAG) --- */
    .bottom-section { grid-column: 1 / -1; grid-row: 4 / 5; display: flex; gap: 15px; height: 100%; min-height: 250px; }
    
    /* Re-styling terminal to fit in split view */
    .terminal-panel { flex: 6; background: #000; border: 1px solid var(--cyber-green); padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--cyber-green); overflow-y: auto; box-shadow: inset 0 0 20px rgba(5, 255, 161, 0.1); display: flex; flex-direction: column; }
    .terminal { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; }

    /* MAG PANEL STYLES (NEW ADDITION) */
    .mag-panel { flex: 4; border: 1px solid var(--cyber-yellow); display: flex; flex-direction: column; background: var(--panel-bg); clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px); }
    .mag-content { flex: 1; padding: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; font-family: 'Share Tech Mono'; }
    
    .mag-section-title { font-size: 10px; color: #888; border-bottom: 1px solid #333; margin-bottom: 5px; padding-bottom: 2px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
    .mag-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; margin-bottom: 4px; }
    .mag-val { font-weight: bold; color: white; }
    
    .stress-bar-box { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-top: 2px; }
    .stress-bar { height: 100%; background: var(--cyber-green); width: 0%; transition: width 0.2s, background 0.2s; }
    
    .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #222; color: #888; text-align: center; width: 100%; margin-top: 5px; border: 1px solid #444; }
    .status-ok { background: rgba(5, 255, 161, 0.2); color: var(--cyber-green); border-color: var(--cyber-green); }

    /* RESPONSIVE */
    @media (min-width: 1025px) { .cockpit { grid-template-columns: 340px 1fr 340px; } }
    @media (max-width: 1024px) { 
        .cockpit { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto auto auto auto; }
        .video-section { grid-column: 1 / -1; grid-row: 1; height: 320px; }
        .speed-panel { grid-column: 1 / 2; grid-row: 2; height: 280px; }
        .data-panel { grid-column: 2 / 3; grid-row: 2; height: 280px; }
        .map-panel { grid-column: 1 / -1; grid-row: 3; height: 300px; }
        #locked-panel, .control-container { grid-column: 1 / -1; grid-row: 4; }
        .bottom-section { grid-column: 1 / -1; grid-row: 5; height: 250px; }
    }
    @media (max-width: 600px) { 
        .cockpit { display: flex; flex-direction: column; gap: 20px; }
        .video-section { height: auto; gap: 10px; } .cam-box { height: 200px; }
        .map-panel { height: 300px !important; }
        .bottom-section { flex-direction: column; height: auto; gap: 15px; }
        .terminal-panel, .mag-panel { min-height: 200px; }
        header { flex-wrap: wrap; justify-content: center; }
    }

    /* Modals */
    #dataModal, #loginModal, #logsModal, #maintModal, #isoModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; padding: 20px; overflow-y: auto; justify-content: center; align-items: center; }
    .modal-content { max-width: 1000px; margin: 40px auto; color: white; border: 1px solid var(--cyber-blue); padding: 20px; background: #111; box-shadow: 0 0 30px var(--cyber-blue); }
    .chart-box { background: #080a10; border: 1px solid #333; padding: 15px; border-radius: 8px; }
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    @media (max-width: 700px) { .charts-grid { grid-template-columns: 1fr; } }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; min-width: 800px; }
    th, td { border: 1px solid #444; padding: 10px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    th { color: var(--cyber-blue); background: rgba(0,240,255,0.05); text-transform: uppercase; font-weight: bold; position: sticky; top: 0; background: #080a10; z-index: 5; }
    tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    
    /* Login Box */
    .login-box { background: #050505; border: 2px solid var(--cyber-red); padding: 40px; text-align: center; box-shadow: 0 0 40px var(--cyber-red); width: 100%; max-width: 400px; }
    .login-input { width: 100%; background: #111; border: 1px solid #444; padding: 15px; color: white; margin: 10px 0; font-family: 'Oxanium'; font-size: 18px; outline: none; text-align: center; transition: 0.3s; }
    .login-input:focus { border-color: var(--cyber-red); box-shadow: 0 0 10px var(--cyber-red); }
    .login-btn { width: 100%; background: var(--cyber-red); color: white; border: none; padding: 15px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 10px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: 0.2s; }
    .login-btn:hover { background: white; color: red; }

    @keyframes blink { 50% { opacity: 0; } }
    @keyframes blinkFast { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    @keyframes flicker { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    @keyframes pulseRed { 50% { box-shadow: inset 0 0 40px rgba(255,0,0,0.3); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD69TabKnrT2AnF3ck6B1gHx5BlVNwYmXs",
      authDomain: "mpm-raiv.firebaseapp.com",
      databaseURL: "https://mpm-raiv-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mpm-raiv",
      storageBucket: "mpm-raiv.firebasestorage.app",
      messagingSenderId: "438673223474",
      appId: "1:438673223474:web:2e68b8cc948f6af3dbf12b",
      measurementId: "G-XDNJ8DCK95"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // VARS
    let navMode = "meters"; let sliderValue = 0.5; let mapLoc = { lat: 0, lng: 0 };
    let userLoc = null;
    let currentSpeedDisplay = 0.0; let targetSpeed = 0.0;
    let charts = { c1: null, c2: null, c3: null, c4: null };
    
    // UPDATED COORDINATES
    const SEMENYIH_LAT = 3.128625;
    const SEMENYIH_LNG = 101.738602;
    const DEFAULT_CAM_URL = "https://preceding-headlines-directories-clearance.trycloudflare.com";
    let isVehicleMoving = false; // Flag for Movement
    
    // --- SENSOR WATCHDOG ---
    let lastSensorHeartbeat = 0;
    let isSensorOnline = false;

    // --- PHYSICS LOOP ---
    function animateSpeed() {
        if (Math.abs(targetSpeed - currentSpeedDisplay) > 0.01) {
            let step = 0.05; if (targetSpeed < currentSpeedDisplay) step = 0.1;
            if (currentSpeedDisplay < targetSpeed) currentSpeedDisplay += step; else currentSpeedDisplay -= step;
        } else { currentSpeedDisplay = targetSpeed; }
        if(currentSpeedDisplay < 0.05) currentSpeedDisplay = 0;
        
        // Digital Update
        document.getElementById('speed-val').innerText = currentSpeedDisplay.toFixed(2);
        requestAnimationFrame(animateSpeed);
    }
    requestAnimationFrame(animateSpeed);

    // --- MMM SENSOR SIMULATION (PHYSICS ENGINE) ---
    // Simulates "Self-Magnetic Leakage Field" logic:
    // Hp: Tangential Field
    // Hz: Normal Field
    let simHp = 20; let simHz = 10; 
    
    function updateMagneticSim() {
        if (!isVehicleMoving) {
            // SAFE MODE / STANDBY
            document.getElementById('mmm-hp').innerText = "0.0 A/m";
            document.getElementById('mmm-hz').innerText = "0.0 A/m";
            document.getElementById('mmm-status').innerText = "SENSOR STANDBY";
            document.getElementById('mmm-status').className = "status-badge status-ok";
            document.getElementById('bar-hp').style.width = "0%";
            return;
        }

        // Random Fluctuation (Safe Zone Only)
        // Hp Safe Range: 20-35
        // Hz Safe Range: 5-15
        simHp = 25 + (Math.random() - 0.5) * 10; // 20 to 30
        simHz = 10 + (Math.random() - 0.5) * 5;  // 7.5 to 12.5
        
        // Update UI
        document.getElementById('mmm-hp').innerText = simHp.toFixed(1) + " A/m";
        document.getElementById('mmm-hz').innerText = simHz.toFixed(1) + " A/m";
        
        document.getElementById('mmm-status').innerText = "HEALTHY RAIL SIGNATURE";
        document.getElementById('mmm-status').className = "status-badge status-ok";
        
        // Bars
        let hpPct = (simHp / 50) * 100; // 50 is scale max
        document.getElementById('bar-hp').style.width = hpPct + "%";
        document.getElementById('bar-hp').style.background = "var(--cyber-green)";
    }
    setInterval(updateMagneticSim, 500);

    // --- DATA MOCKER ---
    function generateMockData(count = 10) {
        const rows = [];
        let baseTime = Date.now();
        for(let i=1; i<=count; i++) {
            let tStart = baseTime - (i * 300000); 
            let tStop = tStart + 120000;
            let sLat = SEMENYIH_LAT + (Math.random() * 0.005);
            let sLng = SEMENYIH_LNG + (Math.random() * 0.005);
            
            rows.push({
                trip: i, 
                start_loc: sLat.toFixed(4) + ", " + sLng.toFixed(4),
                start_time: new Date(tStart).toLocaleTimeString(),
                stop_loc: (sLat+0.001).toFixed(4) + ", " + sLng.toFixed(4),
                stop_time: new Date(tStop).toLocaleTimeString(),
                speed: (Math.random()*2 + 0.5).toFixed(1),
                vert_rms: (Math.random()*1.1+0.07).toFixed(2),
                lat_rms: (Math.random()*1.6+0.05).toFixed(2),
                comfort: (Math.random()*(0.315-0.157)+0.157).toFixed(3),
                dist: (Math.random()*3 + 0.5).toFixed(1)
            });
        }
        return rows.reverse(); 
    }

    // --- LOGIN ---
    window.openLogin = () => { document.getElementById('loginModal').style.display = 'flex'; }
    window.performLogin = () => {
        if(document.getElementById('user').value==="admin" && document.getElementById('pass').value==="admin") {
            document.getElementById('loginModal').style.display='none';
            document.getElementById('locked-panel').style.display='none';
            document.getElementById('control-container').style.display='flex';
            document.getElementById('speed-select-box').style.display='block';
            logEvent("[AUTH] ACCESS GRANTED");
        } else {
            alert("INVALID CREDENTIALS");
            logEvent("[AUTH] ACCESS DENIED");
        }
    }
    
    // --- SPEED CONTROL ---
    window.setSpeed = (val) => {
        const speedMs = parseFloat(val); 
        targetSpeed = speedMs; 
        let pct = Math.floor((speedMs * 35) + 20);
        if(pct > 200) pct = 200; if(pct < 25) pct = 25;
        update(ref(db), { "speed_factor": pct });
    }

    // --- USER GPS ---
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                if(mapLoc.lat !== 0) {
                     const d = calcDistance(userLoc.lat, userLoc.lng, mapLoc.lat, mapLoc.lng);
                     document.getElementById('user-dist').innerText = d.toFixed(2) + " km";
                }
            }, () => {
                logEvent("[GPS] DENIED");
            });
        }
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lat2) return 0;
      var R = 6371; 
      var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      return R * c; 
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // --- CAM SYNC ---
    let currentCamUrl = "";
    const camUrlRef = ref(db, 'cam_url');
    onValue(camUrlRef, (snapshot) => {
      const rawUrl = snapshot.val();
      if(rawUrl) {
        const url = rawUrl.trim().replace(/['"]+/g, '');
        if(url !== currentCamUrl) {
            currentCamUrl = url;
            logEvent("[SYS] NEW CAM LINK");
            if(document.getElementById('cam-url').value === "") {
                document.getElementById('cam-url').value = url;
                connectCams(url);
            }
        }
      }
    });

    // --- NAV LOGIC ---
    // Fix: Updated directions URL
    window.getDirections = () => {
        if(mapLoc.lat !== 0 && mapLoc.lng !== 0) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${mapLoc.lat},${mapLoc.lng}`, '_blank');
        } else {
            alert("No target location available.");
        }
    }

    window.updateNavMode = () => {
        navMode = document.getElementById('move-mode').value;
        const sl = document.getElementById('slider-cont');
        const slider = document.getElementById('dist-slider');
        const valDisp = document.getElementById('slider-val');
        
        if(navMode==="hold") { sl.style.opacity=0.3; sl.style.pointerEvents="none"; valDisp.innerText="MANUAL"; }
        else {
            sl.style.opacity=1; sl.style.pointerEvents="auto";
            if(navMode==="meters") { slider.min=0.5; slider.max=5; slider.step=0.5; slider.value=0.5; window.updateDist(0.5); }
            if(navMode==="km") { slider.min=1; slider.max=20; slider.step=1; slider.value=1; window.updateDist(1); }
        }
    }
    window.updateDist = (v) => { sliderValue=v; document.getElementById('slider-val').innerText=v+(navMode==="meters"?" m":" km"); }

    // FIXED: Appended unique timestamp to every command to ensure it's always new
    window.sendCommand = (c) => { 
        const uniqueCmd = c + "_" + Date.now();
        set(ref(db, 'command'), uniqueCmd); 
        logEvent(`CMD: ${c}`); 
    }

    window.handlePress = (dir, e) => {
        if(e && e.cancelable) e.preventDefault();
        if (navMode === "hold") { 
            // Fix: Send a virtual long distance command to act as "Hold"
            let cmd = (dir === "FORWARD") ? "FWD_50" : "BWD_50";
            sendCommand(cmd);
        } 
        else {
            let d = (navMode==="meters") ? sliderValue : sliderValue*1000;
            let prefix = (dir==="FORWARD"?"FWD_":"BWD_");
            sendCommand(prefix + d);
            logEvent(`[NAV] AUTO: ${d}m`);
        }
    }
    window.handleRelease = (e) => { 
        if(e && e.cancelable) e.preventDefault(); 
        if(navMode==="hold") sendCommand('STOP'); 
    }
    

    window.connectCams = (passedUrl = null) => {
        let url = passedUrl || document.getElementById('cam-url').value || DEFAULT_CAM_URL;
        const t = Date.now();
        const cams = [1,2,3,4];
        cams.forEach(i => {
            let img = document.getElementById('stream'+i);
            img.src = url + "/video"+i+"?t="+t;
            img.onload = () => { img.style.display='block'; document.getElementById('nosig'+i).style.display='none'; }
            img.onerror = () => { img.style.display='none'; document.getElementById('nosig'+i).style.display='block'; }
        });
    }
    window.toggleMaint = () => document.getElementById('maintModal').style.display='flex';
    window.closeModal = (id) => document.getElementById(id).style.display='none';

    // --- FIREBASE LISTENERS ---
    
    // 1. HALL SENSORS (LIVE DATA + HEARTBEAT)
    onValue(ref(db, 'telemetry/hall_sensors'), (snap) => {
        const d = snap.val();
        
        // Update Heartbeat
        lastSensorHeartbeat = Date.now();
        if (!isSensorOnline) {
            isSensorOnline = true;
            logEvent("[HALL] SENSOR NODE CONNECTED");
            document.getElementById('offline-mask').style.display = 'none';
        }

        if(d) {
             if (isVehicleMoving) {
                // H1
                document.getElementById('h1-val').innerText = (d.h1 && d.h1.val) ? d.h1.val : "0";
                const trig1 = (d.h1 && d.h1.trig);
                document.getElementById('h1-led').style.background = trig1 ? "var(--cyber-red)" : "#333";
                document.getElementById('h1-led').style.boxShadow = trig1 ? "0 0 10px red" : "none";
                
                // H2
                document.getElementById('h2-val').innerText = (d.h2 && d.h2.val) ? d.h2.val : "0";
                const trig2 = (d.h2 && d.h2.trig);
                document.getElementById('h2-led').style.background = trig2 ? "var(--cyber-red)" : "#333";
                document.getElementById('h2-led').style.boxShadow = trig2 ? "0 0 10px red" : "none";
             } else {
                // FORCE 0 IF STOPPED
                document.getElementById('h1-val').innerText = "0";
                document.getElementById('h1-led').style.background = "#333";
                document.getElementById('h1-led').style.boxShadow = "none";
                document.getElementById('h2-val').innerText = "0";
                document.getElementById('h2-led').style.background = "#333";
                document.getElementById('h2-led').style.boxShadow = "none";
             }
        }
    });
    
    // SENSOR WATCHDOG (Run every 500ms)
    setInterval(() => {
        const timeSinceLast = Date.now() - lastSensorHeartbeat;
        // If more than 3000ms (3 seconds) without data, assume OFFLINE
        if (timeSinceLast > 3000 && isSensorOnline) {
            isSensorOnline = false;
            logEvent("[WARN] SENSOR NODE LOST");
            // Trigger Offline UI
            document.getElementById('offline-mask').style.display = 'flex';
            
            // Clear values
            document.getElementById('vib-val').innerText = "--";
            document.getElementById('vert-val').innerText = "--";
            document.getElementById('lat-val').innerText = "--";
        }
    }, 500);

    // --- TELEMETRY ---
    let startTime = null;
    let speedLog = [], vertLog = [], latLog = [], comfortLog = [];

    const telemetryRef = ref(db, 'telemetry');
    onValue(telemetryRef, (snapshot) => {
      const data = snapshot.val();
      if(data) {
        // MOVEMENT CHECK - GLOBAL FLAG
        isVehicleMoving = (data.status === "MOVING");
        
        // ONLY UPDATE UI IF SENSOR IS ONLINE
        if (isSensorOnline) {
            updateUI(data);
        }
        
        const spd = data.speed || 0;
        let vib = data.vibration || 0;
        let vert = data.vertical || 0;
        
        if(data.status === "MOVING") {
            // Force Speedometer to match Selector
            let sel = parseFloat(document.getElementById('spd-select').value);
            targetSpeed = sel;

            if(!startTime) {
                startTime = new Date();
                speedLog = []; vertLog = []; latLog = []; comfortLog = [];
                logEvent("[SYS] MISSION STARTED");
            }
            // Sim Data
            if(vib === 0) vib = (Math.random() * (0.315 - 0.157) + 0.157);
            if(vert === 0) vert = (Math.random() * (1.2 - 0.07) + 0.07);
            let l = (Math.random() * (1.7 - 0.05) + 0.05);
            
            speedLog.push(spd); vertLog.push(vert); latLog.push(l); comfortLog.push(vib);
        } 
        else if(data.status === "STANDBY") {
            targetSpeed = 0.0; 
            if (startTime) {
                logEvent("[SYS] MISSION COMPLETE");
                saveLog(new Date());
                startTime = null; // Reset
            }
        }
      }
    });

    function saveLog(stopTime) {
        if(!startTime) return;
        const dur = ((stopTime - startTime) / 1000).toFixed(1);
        const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : "0.00";
        
        const logData = {
            start_time: startTime.toLocaleTimeString(),
            stop_time: stopTime.toLocaleTimeString(),
            start_loc: mapLoc.lat.toFixed(4)+", "+mapLoc.lng.toFixed(4),
            stop_loc: mapLoc.lat.toFixed(4)+", "+mapLoc.lng.toFixed(4),
            speed: avg(speedLog) + " m/s",
            vert_rms: avg(vertLog) + " mm/sÂ²",
            lat_rms: avg(latLog) + " mm/sÂ²",
            comfort: avg(comfortLog) + " m/sÂ²",
            dist: (navMode==="meters" ? sliderValue + " m" : "MANUAL"),
            ts: Date.now()
        };
        push(ref(db, 'mission_logs'), logData);
    }

    window.showData = function() {
        document.getElementById('dataModal').style.display = 'flex';
        const tbody = document.getElementById('logsBody');
        tbody.innerHTML = "<tr><td colspan='10'>Syncing Cloud...</td></tr>";
        
        const q = query(ref(db, 'mission_logs'), limitToLast(10));
        onValue(q, (snap) => {
            tbody.innerHTML = "";
            let logs = [];
            snap.forEach(c => logs.unshift(c.val()));
            
            let data = [...logs];
            if(data.length < 10) {
                 const mock = generateMockData(10 - data.length);
                 data = data.concat(mock);
            }

            let trip = 1;
            data.forEach(l => {
                const row = `<tr>
                    <td>${trip++}</td>
                    <td>${l.start_loc || "2.9582, 101.8236"}</td><td>${l.start_time}</td>
                    <td>${l.stop_loc || "2.9582, 101.8236"}</td><td>${l.stop_time}</td>
                    <td style="color:cyan">${l.speed}</td>
                    <td style="color:yellow">${l.vert_rms}</td>
                    <td style="color:orange">${l.lat_rms}</td>
                    <td style="color:lime">${l.comfort}</td>
                    <td>${l.dist}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            initCharts(data);
        }, {onlyOnce:true});
    }

    function updateUI(data) {
      let speedKmh = data.speed || 0;
      if (speedKmh < 0.5) speedKmh = 0.0;
      targetSpeed = speedKmh / 3.6; 
      
      let vib = data.vibration || 0;
      let vert = data.vertical || 0;
      let latMove = 0;
      let comfort = 0;
      
      if (data.status === "MOVING") {
          if(vib === 0) vib = (Math.random() * (0.13 - 0.04) + 0.04);
          else vib += (Math.random() - 0.5) * 0.05; 
          
          if(vert === 0) vert = (Math.random() * (1.2 - 0.07) + 0.07);
          else vert += (Math.random() - 0.5) * 0.1;
          
          latMove = (Math.random() * (1.7 - 0.05) + 0.05);
          comfort = (Math.random() * (0.315 - 0.157) + 0.157);
      }

      document.getElementById('vib-val').innerText = Math.abs(comfort).toFixed(3) + " m/sÂ²";
      document.getElementById('vert-val').innerText = Math.abs(vert).toFixed(2) + " mm";
      document.getElementById('lat-val').innerText = Math.abs(latMove).toFixed(2) + " mm";
      
      if(data.targ_dist) document.getElementById('dist-val').innerText = (data.prog_dist || 0).toFixed(1) + " / " + data.targ_dist.toFixed(1) + " m";
      else document.getElementById('dist-val').innerText = "MANUAL";

      const statusEl = document.getElementById('status-txt');
      if(data.status === "MOVING") { 
          statusEl.innerText = "MOVING"; statusEl.style.color = "var(--cyber-green)"; 
          document.querySelector('.led-red').classList.remove('active');
          document.querySelector('.led-orange').classList.add('active');
      } else { 
          statusEl.innerText = "STANDBY"; statusEl.style.color = "var(--cyber-yellow)"; 
          document.querySelector('.led-red').classList.add('active');
          document.querySelector('.led-orange').classList.remove('active');
      }
      
      // --- FORCE NEW COORDINATES (IGNORE FIREBASE) ---
      // Since the GPS sensor is removed, we strictly use the hardcoded demo location
      // This prevents old database values from overriding the map
      let displayLat = SEMENYIH_LAT;
      let displayLng = SEMENYIH_LNG;
      let statusText = "SAT LINK: LOCKED (SIM)"; // Indicate simulated lock

      /* OLD LOGIC COMMENTED OUT TO PREVENT OVERRIDE
      if(data.lat && data.lat !== 0) { 
          displayLat = data.lat; displayLng = data.lng; statusText = "SAT LINK: LOCKED";
      }
      */
      
      mapLoc = { lat: displayLat, lng: displayLng };
      updateMap(displayLat, displayLng);
      document.getElementById('loc-text').innerText = `${statusText} | LAT: ${displayLat.toFixed(5)} LNG: ${displayLng.toFixed(5)}`;
      
      if(userLoc) {
          const d = calcDistance(userLoc.lat, userLoc.lng, displayLat, displayLng);
          document.getElementById('user-dist').innerText = d.toFixed(2) + " km";
      }
    }

    function logEvent(msg) {
      const term = document.getElementById('terminal');
      const time = new Date().toLocaleTimeString('en-US', {hour12:false});
      const line = document.createElement('div');
      line.innerText = `[${time}] > ${msg}`;
      term.prepend(line);
      if(term.children.length > 20) term.lastChild.remove();
    }

    let map, marker;

    function initMap() { 
      map = L.map('map').setView([SEMENYIH_LAT, SEMENYIH_LNG], 10); 
      L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
      }).addTo(map);
      
      marker = L.circleMarker([SEMENYIH_LAT, SEMENYIH_LNG], {
            color: 'red', fillColor: '#f03', fillOpacity: 1, radius: 10, weight: 3
      }).addTo(map);
    }
    
    function updateMap(lat, lng) { 
        if (!map) return; 
        if (marker) map.removeLayer(marker);
        marker = L.circleMarker([lat, lng], {
            color: 'red', fillColor: '#f03', fillOpacity: 1, radius: 10, weight: 3
        }).addTo(map);
        map.setView([lat, lng], 18); 
    }
    
    function initCharts(data) {
        const labels = data.map((l, i) => "TRIP " + (i+1));
        const spd = data.map(l => parseFloat(l.speed));
        const vert = data.map(l => parseFloat(l.vert_rms));
        const lat = data.map(l => parseFloat(l.lat_rms));
        const comf = data.map(l => parseFloat(l.comfort));

        const getAvg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

        const cfg = (lbl, col, d, avgVal) => ({
            type: 'line',
            data: { 
                labels: labels, 
                datasets: [
                    { label: lbl, borderColor: col, borderWidth: 2, backgroundColor: col+'33', fill:true, data: d },
                    { label: 'AVG', borderColor: '#ffffff', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false, data: Array(d.length).fill(avgVal) }
                ] 
            },
            options: { scales: { x: { display: false }, y: { grid: { color: '#333' } } }, plugins: { legend: { labels: { color: 'white' } } }, animation: { duration: 2000 } }
        });
        
        if(charts.c1) charts.c1.destroy();
        if(charts.c2) charts.c2.destroy();
        if(charts.c3) charts.c3.destroy();
        if(charts.c4) charts.c4.destroy();

        if(document.getElementById('c1')) {
            const avgSpd = getAvg(spd);
            document.getElementById('avg-c1').innerText = "AVG: " + avgSpd.toFixed(2);
            charts.c1 = new Chart(document.getElementById('c1').getContext('2d'), cfg('SPEED (m/s)', '#00f0ff', spd, avgSpd));
            
            const avgVert = getAvg(vert);
            document.getElementById('avg-c2').innerText = "AVG: " + avgVert.toFixed(2);
            charts.c2 = new Chart(document.getElementById('c2').getContext('2d'), cfg('VERT RMS', '#05ffa1', vert, avgVert));
            
            const avgLat = getAvg(lat);
            document.getElementById('avg-c3').innerText = "AVG: " + avgLat.toFixed(2);
            charts.c3 = new Chart(document.getElementById('c3').getContext('2d'), cfg('LAT RMS', '#ff5e00', lat, avgLat));
            
            const avgComf = getAvg(comf);
            document.getElementById('avg-c4').innerText = "AVG: " + avgComf.toFixed(2);
            charts.c4 = new Chart(document.getElementById('c4').getContext('2d'), cfg('COMFORT', '#fcee0a', comf, avgComf));
        }
    }

    function updateTime() {
      const t = new Date().toLocaleTimeString('en-US', {timeZone: 'Asia/Kuala_Lumpur', hour12:false});
      document.getElementById('kl-time').innerText = "MYT " + t;
    }

    window.onload = () => { 
        setTimeout(() => { 
            initMap(); logEvent("[SYSTEM] INITIALIZED"); 
            updateTime(); setInterval(updateTime, 1000);
            getUserLocation();
            
            const DEFAULT_CAM_URL = "https://preceding-headlines-directories-clearance.trycloudflare.com";
            if(document.getElementById('cam-url').value === "") {
               // document.getElementById('cam-url').value = DEFAULT_CAM_URL;
               // connectCams(DEFAULT_CAM_URL);
            }
            
            document.getElementById('move-mode').value = "meters";
            updateNavMode();
            
        }, 1000); 
    }
    window.openData = () => { document.getElementById('dataModal').style.display = 'block'; showData(); }
    window.closeModal = (id) => document.getElementById(id).style.display='none';
  </script>
</head>
<body>
  <header>
    <div class="brand">MPM-RAIV <span style="font-size:12px; color:white; opacity:0.7;">// COMMAND</span></div>
    <div class="header-right">
        <div class="time-box" id="kl-time">MYT --:--:--</div>
        <div class="led-panel">
            <div class="led led-red active"></div><span class="led-label">STBY</span>
            <div class="led led-orange"></div><span class="led-label">MOV</span>
        </div>
        <button class="maint-btn" onclick="toggleMaint()">MAINTENANCE</button>
    </div>
  </header>
  
  <div class="cockpit">
    <!-- VIDEO -->
    <div class="video-section">
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 01 // FRONT</div><img id="stream1" class="stream-img"><div id="nosig1" class="no-sig">NO SIGNAL</div></div>
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 02 // REAR</div><img id="stream2" class="stream-img"><div id="nosig2" class="no-sig">NO SIGNAL</div></div>
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 03 // LEFT TRACK</div><img id="stream3" class="stream-img"><div id="nosig3" class="no-sig">NO SIGNAL</div></div>
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 04 // RIGHT TRACK</div><img id="stream4" class="stream-img"><div id="nosig4" class="no-sig">NO SIGNAL</div></div>
    </div>

    <!-- MAP -->
    <div class="panel map-panel">
      <div class="panel-header"><span id="loc-text">LOCATING...</span><span>SAT LINK</span></div>
      <div class="map-container"><div id="map"></div><div class="map-overlay"><button class="btn-dir" onclick="getDirections()">GET DIRECTIONS &#8599;</button></div></div>
    </div>

    <!-- SPEED & SLIDER -->
    <div class="panel speed-panel">
      <div class="panel-header"><span>SPEEDOMETER</span><span>M/S</span></div>
      
      <!-- DIGITAL DISPLAY REPLACEMENT -->
      <div class="digital-speed-container">
          <div class="speed-label-top">SPEED CONTROL</div>
          <div id="speed-val" class="digital-speed-val">0.00</div>
          <div class="digital-unit">M/S</div>
      </div>

      <div id="speed-select-box">
         <div class="spd-title">TARGET SPEED</div>
         <select id="spd-select" class="spd-dropdown" onchange="setSpeed(this.value)">
             <option value="0.2">0.2 m/s</option>
             <option value="0.5" selected>0.5 m/s</option>
             <option value="1.0">1.0 m/s</option>
             <option value="1.5">1.5 m/s</option>
             <option value="2.0">2.0 m/s</option>
             <option value="2.5">2.5 m/s</option>
             <option value="3.0">3.0 m/s</option>
             <option value="4.0">4.5 m/s</option>
             <option value="5.0">5.5 m/s</option>
         </select>
      </div>
    </div>

    <!-- DATA -->
    <div class="panel data-panel">
      <div class="panel-header"><span>TELEMETRY STREAM</span><span>LIVE</span></div>
      
      <!-- OFFLINE OVERLAY -->
      <div id="offline-mask" class="offline-overlay">
          <div class="offline-text">SENSOR NODE OFFLINE</div>
          <div class="offline-sub">WAITING FOR MAGNETIC LINK...</div>
      </div>

      <div class="data-scroll">
          <div class="data-row"><span>TRACK COMFORT LEVEL <button class="info-btn" onclick="document.getElementById('isoModal').style.display='flex'">i</button></span> <span id="vib-val" class="val" style="color:var(--cyber-yellow);">0.000 m/sÂ²</span></div>
          <div class="data-row"><span>VERTICAL MOVEMENT RMS</span> <span id="vert-val" class="val" style="color:var(--cyber-green);">0.00 mm/sÂ²</span></div>
          <div class="data-row"><span>LATERAL MOVEMENT RMS</span> <span id="lat-val" class="val" style="color:var(--cyber-orange);">0.00 mm/sÂ²</span></div>
          <div class="data-row"><span>CONTROL MODE</span> <span id="dist-val" class="val">MANUAL</span></div>
          <div class="data-row"><span>DISTANCE TO RAIV</span> <span id="user-dist" class="val">LOCATING...</span></div>
          <div class="data-row"><span>STATUS</span> <span id="status-txt" class="val" style="color:lime;">STANDBY</span></div>
      </div>
    </div>
    
    <!-- LOCKED PANEL -->
    <div id="locked-panel" onclick="openLogin()">
        <span style="font-size:40px;">ðŸ”’</span>
        <div class="lock-text">SYSTEM LOCKED // ACCESS CONTROLS</div>
    </div>

    <!-- CONTROLS (HIDDEN) -->
    <div id="control-container" class="control-container">
      <div class="nav-panel">
        <div class="nav-row"><label>NAV MODE:</label><select id="move-mode" onchange="updateNavMode()"><option value="hold">AUTO HOLD (MANUAL)</option><option value="meters" selected>METERS (AUTO)</option><option value="km">KILOMETERS (AUTO)</option></select></div>
        <div class="nav-row slider-container" id="slider-cont"><label>DIST:</label><input type="range" id="dist-slider" oninput="updateDist(this.value)"><div id="slider-val" class="slider-val">0.5 m</div></div>
        <!-- Removed Configure Link -->
      </div>
      <div class="control-bar">
        <button class="btn btn-fwd" onmousedown="handlePress('FORWARD', event)" onmouseup="handleRelease(event)" ontouchstart="handlePress('FORWARD', event)" ontouchend="handleRelease(event)" onmouseleave="handleRelease(event)" ontouchcancel="handleRelease(event)">FORWARD</button>
        <button class="btn btn-stop" onclick="sendCommand('STOP')">STOP</button>
        <button class="btn btn-bwd" onmousedown="handlePress('BACKWARD', event)" onmouseup="handleRelease(event)" ontouchstart="handlePress('BACKWARD', event)" ontouchend="handleRelease(event)" onmouseleave="handleRelease(event)" ontouchcancel="handleRelease(event)">BACKWARD</button>
        <button class="btn btn-data" onclick="showData()">DATA</button>
      </div>
    </div>
    
    <!-- BOTTOM SECTION (TERMINAL + MAGNETIC SENSOR) -->
    <div class="bottom-section">
        <!-- SYSTEM CONSOLE -->
        <div class="panel terminal-panel">
            <div class="panel-header">SYSTEM CONSOLE</div>
            <div id="terminal" class="terminal">
                <div>> SYSTEM INITIALIZED...</div>
            </div>
        </div>

        <!-- MAG INSPECTION UNIT -->
        <div class="panel mag-panel">
            <div class="panel-header">MAGNETIC INSPECTION UNIT</div>
            <div class="mag-content">
                <!-- MMM Section (Simulated) -->
                <div>
                    <div class="mag-section-title">MMM SENSOR [STRESS ANALYSIS] <button class="info-btn" onclick="alert('MMM: Metal Magnetic Memory. Measures stress concentration zones.')">i</button></div>
                    <div class="mag-row"><span>Hp (Tangential):</span><span id="mmm-hp" class="mag-val" style="color:var(--cyber-blue);">0.0 A/m</span></div>
                    <div class="stress-bar-box"><div id="bar-hp" class="stress-bar"></div></div>
                    <div class="mag-row" style="margin-top:4px;"><span>Hz (Normal):</span><span id="mmm-hz" class="mag-val" style="color:var(--cyber-yellow);">0.0 A/m</span></div>
                    <div id="mmm-status" class="status-badge status-ok">SENSOR STANDBY</div>
                </div>

                <!-- Hall Sensor Section (Live) -->
                <div style="border-top:1px solid #333; padding-top:5px; margin-top:5px;">
                    <div class="mag-section-title">HALL SENSORS [MAGNETIC FLUX]</div>
                    <!-- Hall 1 -->
                    <div class="mag-row">
                        <span>SENSOR 01 (L):</span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span id="h1-val" class="mag-val">0</span> <span style="font-size:9px; color:#666;"> mG RAW</span>
                            <div id="h1-led" style="width:8px; height:8px; border-radius:50%; background:#333; border:1px solid #555;"></div> <span style="font-size:9px;">TRIG</span>
                        </div>
                    </div>
                    <!-- Hall 2 -->
                    <div class="mag-row">
                        <span>SENSOR 02 (R):</span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span id="h2-val" class="mag-val">0</span> <span style="font-size:9px; color:#666;"> mG RAW</span>
                            <div id="h2-led" style="width:8px; height:8px; border-radius:50%; background:#333; border:1px solid #555;"></div> <span style="font-size:9px;">TRIG</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- MODALS (Login, Maint, Data, ISO) -->
  <div id="loginModal" class="modal"><div class="login-box"><h2 style="color:var(--cyber-red);">AUTHORIZATION</h2><input type="text" id="user" class="login-input" placeholder="USERNAME"><input type="password" id="pass" class="login-input" placeholder="PASSWORD"><button class="login-btn" onclick="performLogin()">UNLOCK</button></div></div>
  
  <div id="maintModal" class="modal"><div class="modal-content" style="max-width:400px; height:auto;"><h3 style="color:var(--cyber-blue);">MAINTENANCE</h3><input type="text" id="cam-url" placeholder="Paste Cloudflare URL..." style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white;"><button onclick="connectCams(); closeModal('maintModal');" style="width:100%; margin-top:10px; background:var(--cyber-green); padding:10px; border:none; font-weight:bold; cursor:pointer;">UPDATE LINK</button><button onclick="closeModal('maintModal')" style="margin-top:10px; width:100%; background:none; border:1px solid #444; color:#aaa; padding:5px; cursor:pointer;">CLOSE</button></div></div>

  <div id="isoModal" class="modal"><div class="modal-content" style="max-width:500px; height:auto;"><h3 style="color:var(--cyber-blue);">ISO 2631 COMFORT</h3><button onclick="closeModal('isoModal')" class="close-btn" style="float:right; background:none; border:none; color:white; font-size:20px;">X</button><table style="margin-top:10px; color:white;"><tr><th>RMS Acc</th><th>Comfort Level</th></tr><tr><td>< 0.315</td><td style="color:#0f0;">Not uncomfortable</td></tr><tr><td>0.315-0.63</td><td style="color:#af0;">A little uncomfortable</td></tr><tr><td>0.5-1.0</td><td style="color:#ff0;">Fairly uncomfortable</td></tr><tr><td>0.8-1.6</td><td style="color:#fa0;">Uncomfortable</td></tr><tr><td>1.25-2.5</td><td style="color:#f50;">Very uncomfortable</td></tr><tr><td>> 2.0</td><td style="color:#f00;">Extremely uncomfortable</td></tr></table></div></div>

  <div id="dataModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between;">
            <h2 style="color:var(--cyber-green);">MISSION DATA LOGS</h2>
            <button onclick="closeModal('dataModal')" class="close-btn" style="font-size:24px; border:none; background:none; color:white; cursor:pointer;">X</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>TRIP</th><th>START LOC</th><th>START TIME</th><th>STOP LOC</th><th>STOP TIME</th><th>SPEED</th><th>VERT RMS</th><th>LAT RMS</th><th>COMFORT</th><th>DIST</th></tr>
                </thead>
                <tbody id="logsBody"></tbody>
            </table>
        </div>
        
        <div class="charts-grid" style="margin-top:20px;">
            <div class="chart-box"><div class="panel-header">SPEED <span id="avg-c1" style="float:right; font-size:10px; color:white;"></span></div><canvas id="c1"></canvas></div>
            <div class="chart-box"><div class="panel-header">VERT RMS <span id="avg-c2" style="float:right; font-size:10px; color:white;"></span></div><canvas id="c2"></canvas></div>
            <div class="chart-box"><div class="panel-header">LAT RMS <span id="avg-c3" style="float:right; font-size:10px; color:white;"></span></div><canvas id="c3"></canvas></div>
            <div class="chart-box"><div class="panel-header">COMFORT <span id="avg-c4" style="float:right; font-size:10px; color:white;"></span></div><canvas id="c4"></canvas></div>
        </div>
    </div>
  </div>

</body>
</html>
